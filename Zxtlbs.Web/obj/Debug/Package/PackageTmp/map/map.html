<div class="z-wrap"> 
  <!--实时监控 开始-->
  <div id="z-zzgl-list-01" class="z-wrap-height z-sub-payout-bg">
    <div class="z-sub-payout z-sub-main-bg">
      <div class="z-sub-payout-l">
        <div class="z-sub-tools">
          <div class="z-row-oper"> <a href="#" class="z-row-add" onclick="popupBody('#z-zzgl-add')" title="新增"></a><a href="#" class="z-row-edit" onclick="popupBody('#z-zzgl-edit')" title="修改"></a><a href="#" class="z-row-del" onclick="popupBody('#z-zzgl-del')" title="删除"></a><a href="#" class="z-row-up" title="上移"></a><a href="#" class="z-row-down" title="下移"></a> </div>
        </div>
        <div class="z-sub-choose" id="div-devicelist" style="overflow:auto;">
            <div id="loadinfo" style="text-align:center;margin-top:200px;">正在加载设备列表，请稍候…</div>
        </div>
      </div>
      <div style="height:100%;margin-left:0px;" class="z-sub-payout-r z-wrap-pm-bg z-sub-payout-r-bg"> 
        <!--地图开始-->
            <div id="map_canvas" style="width:100%;height:100%;"></div>
        <!--地图结束-->         
      </div>
    </div>
  </div>
  <!--实时监控 结束--> 
</div>
<script type="text/javascript">
    /**地图初始化**/
	var myOptions = {
		zoom: 10,
		center: new google.maps.LatLng(30.556, 114.327),
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
    var map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);
    var infowindow = new google.maps.InfoWindow();
    function zmarker(id, marker, content) {
        this.id = id;
        this.marker = marker;
        this.content = content;
    }
	var markerArray = [];
    /**列表初始化**/
    function loadlist() {
        $('#div-devicelist').load('map/mapleft.ashx', function (response, status, xhr) {
            if (status == "success") {
                zTree();
                var ht = $(window).height() - 70 - 5 - 20 - 30;
                $('#div-devicelist').css("height", ht + "px");
                $('#div-devicelist .z-tree-leaf a').click(function () {
                    var _text = $(this).text();
                    var _id = $(this).attr("id").replace("zxt-d-", "");
                    var _lon = _id.split('|')[1].split(',')[0];
                    var _lat = _id.split('|')[1].split(',')[1];
                    _id = _id.split('|')[0];
                    if(markerArray[_id]) {
                        mshow(_id);
                    } else {
                        madd(_id, _text, _lat, _lon);
                    }
                });
            } else {
                $("#loadinfo").text("加载失败，请<a href=\"loadlist();\">重试</a>");
            }
        });
    }
    $(function () { loadlist(); });
    /**地图函数**/
	function madd(id,name,lat,lng) {
	    var sim = "正在读取";
	    var status = "正在读取";
	    var latlng = new google.maps.LatLng(lat, lng);
	    var marker = new google.maps.Marker({
	        position: latlng,
	        map: map,
	        animation: google.maps.Animation.DROP,
	        title: name,
            id: id,
	    });
	    var content = '<div style="font-size:14px;line-height:22px;"><div style="font-weight:bold;">'
                    + name
                    + '</div><div>设备号码:'
                    + id
                    + '</div><div>SIM卡号:'
                    + sim
                    + '</div><div>设备状态:'
                    + status
                    + '</div></div>';
	    markerArray.push(new zmarker(id, marker, content));
	    markerArray[markerArray[markerArray.length - 1].id] = markerArray[markerArray.length - 1];
	    google.maps.event.addListener(marker, 'click', function (event) {
	        infowindow.setContent(markerArray[marker.id].content);
	        infowindow.open(map, marker);
	    });
	    map.setCenter(latlng);
	    infowindow.setContent(markerArray[id].content);
	    infowindow.open(map, marker);
	}

    function mshow(id){
	    map.setCenter(markerArray[id].marker.position);
	    infowindow.setContent(markerArray[id].content);
	    infowindow.open(map, markerArray[id].marker);
    }
</script>
